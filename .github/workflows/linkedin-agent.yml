name: LinkedIn AI Agent

on:
  schedule:
    # Script has a random delay locally, but we skip delay in CI.
    - cron: '0 11 * * 1'   # Monday 7 AM ET
    - cron: '0 16 * * 3'   # Wednesday 12 PM ET
    - cron: '0 11 * * 5'   # Friday 7 AM ET
  workflow_dispatch:

jobs:
  post-to-linkedin:
    runs-on: ubuntu-latest
    timeout-minutes: 15       # Hard cap for the whole job
    env:
      DISABLE_DELAY: "1"      # Make sure we never sleep in CI
      FORCE_POST: "1"         # Optional: bypass once-per-day guard if you use it

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install requests

      - name: Run LinkedIn Agent
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_PERSON_URN:   ${{ secrets.LINKEDIN_PERSON_URN }}
          GEMINI_API_KEY:        ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY:        ${{ secrets.OPENAI_API_KEY }}  # optional
        run: |
          # Extra protection so the python step can't hang forever
          timeout 10m python linkedin_agent.py

      - name: Commit state file
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add agent_state.json || true
          git commit -m "Update agent state" || true
          git push || true
